<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard ‚Äî Civic Monitoring</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>

    <canvas id="particles-canvas"></canvas>

    <nav class="navbar">
        <span class="logo">üèõÔ∏è Civic Monitor</span>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span class="nav-badge">üõ°Ô∏è Administrator</span>
            <a href="/logout" class="btn btn-nav"
                style="padding: 6px 12px; font-size: 0.8rem; background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2); color: #ef4444;">üö™
                Logout</a>
        </div>
    </nav>

    <div class="page">

        <!-- Stats -->
        <div class="stat-grid stagger">
            <div class="stat-card glass stat-accent">
                <span class="stat-icon">üìä</span>
                <span class="stat-value" data-count="{{ total }}">0</span>
                <span class="stat-label">Total Issues</span>
            </div>
            <div class="stat-card glass stat-orange">
                <span class="stat-icon">üîì</span>
                <span class="stat-value" data-count="{{ open_count }}">0</span>
                <span class="stat-label">Open</span>
            </div>
            <div class="stat-card glass stat-green">
                <span class="stat-icon">‚úÖ</span>
                <span class="stat-value" data-count="{{ closed_count }}">0</span>
                <span class="stat-label">Resolved</span>
            </div>
            <div class="stat-card glass stat-red">
                <span class="stat-icon">üö®</span>
                <span class="stat-value" data-count="{{ critical_count }}">0</span>
                <span class="stat-label">Critical</span>
            </div>
        </div>

        <!-- Resolution Rate -->
        {% if total > 0 %}
        <div class="glass-static section animate-fade-in-up" style="margin-bottom:24px;">
            <div class="section-title">
                <span class="icon">üìà</span> Resolution Rate
            </div>
            <div class="progress-wrap">
                <div class="progress-label">
                    <span>Resolved</span>
                    <span id="rate-pct">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Ward Summary -->
        <div class="glass-static section animate-fade-in-up">
            <div class="section-title">
                <span class="icon">üèòÔ∏è</span> Ward Summary
            </div>
            {% for w in ward_stats %}
            <div class="ward-row">
                <span class="ward-name">Ward {{ w.ward }}</span>
                <span class="ward-stats">
                    <span>üìä {{ w.total }}</span>
                    <span style="color: var(--orange);">üîì {{ w.open }}</span>
                    <span style="color: var(--green);">‚úÖ {{ w.closed }}</span>
                </span>
            </div>
            {% endfor %}
        </div>

        <!-- Issue Type Breakdown -->
        <div class="glass-static section animate-fade-in-up">
            <div class="section-title">
                <span class="icon">üìÇ</span> Issue Types
            </div>
            {% for t in type_stats %}
            <div class="ward-row">
                <span class="ward-name">{{ t.issue_type }}</span>
                <span class="badge badge-open">{{ t.count }}</span>
            </div>
            {% endfor %}
        </div>

        <!-- All Issues -->
        <div class="glass-static section animate-fade-in-up">
            <div class="section-title">
                <span class="icon">üìã</span> All Issues
            </div>
            {% for issue in issues %}
            <div class="issue-row" id="issue-{{ issue.id }}" onclick="viewIssueDetails({
                    id: '{{ issue.id }}',
                    type: '{{ issue.issue_type }}',
                    ward: '{{ issue.ward }}',
                    priority: '{{ issue.priority }}',
                    status: '{{ issue.status }}',
                    before: '{{ issue.before_image }}',
                    after: '{{ issue.after_image }}',
                    confidence: '{{ issue.ai_confidence }}',
                    reasoning: '{{ issue.ai_reasoning | replace(" \"", "&quot;" ) | replace("\n", " " ) |
                replace("\r", "" ) }}' })">
                <div style="flex: 1;">
                    <span style="color:var(--text-dim); font-size:0.75rem; font-family:monospace; margin-right:8px;">#{{
                        issue.id }}</span>
                    <span style="font-weight:700;">{{ issue.issue_type }}</span>
                    <span style="color:var(--text-dim); font-size:0.8rem; margin-left:8px;">Ward {{ issue.ward }}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    {% if issue.status == 'OPEN' %}
                    <span class="badge badge-open">üîì Open</span>
                    {% elif issue.status == 'IN_PROGRESS' %}
                    <span class="badge badge-progress">üîÑ In Progress</span>
                    {% else %}
                    <span class="badge badge-closed">‚úÖ Closed</span>
                    {% endif %}

                    <button onclick="event.stopPropagation(); confirmDelete({{ issue.id }})" class="btn btn-nav"
                        style="padding: 4px 8px; font-size: 0.75rem; background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2); color: #ef4444; min-width: auto; height: auto;">
                        üóëÔ∏è Delete
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

    </div>

    <!-- Issue Detail Modal -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">
                    <span id="modal-icon">üìã</span> <span id="modal-title-text">Issue Details</span>
                </div>
                <button class="btn-close" onclick="closeModal()">‚úï</button>
            </div>

            <div class="image-comparison-grid">
                <div class="img-preview-box">
                    <span class="img-preview-label">BEFORE (Surveyor)</span>
                    <img id="modal-before-img" src="/static/placeholder.webp" alt="Before">
                </div>
                <div class="img-preview-box" id="after-box">
                    <span class="img-preview-label">AFTER (Resolution)</span>
                    <img id="modal-after-img" src="/static/placeholder.webp" alt="After">
                </div>
            </div>

            <div class="detail-section">
                <div class="detail-row">
                    <span class="detail-label">Issue ID</span>
                    <span class="detail-value" id="modal-id">#0</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Category</span>
                    <span class="detail-value" id="modal-type">General</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Location</span>
                    <span class="detail-value" id="modal-ward">Ward 0</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Priority</span>
                    <span class="detail-value" id="modal-priority">Medium</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status</span>
                    <span class="badge" id="modal-status">Open</span>
                </div>
            </div>

            <div class="detail-section" id="ai-section" style="border-left: 4px solid var(--accent);">
                <div
                    style="font-weight: 700; color: var(--accent); margin-bottom: 10px; display: flex; justify-content: space-between;">
                    <span>ü§ñ AI Analysis Intelligence</span>
                    <span id="modal-confidence"
                        style="font-size: 0.8rem; background: var(--accent-glow); padding: 2px 8px; border-radius: 10px;">90%
                        Confident</span>
                </div>
                <div class="ai-reasoning-box" id="modal-reasoning">
                    Standard visual analysis applied. No specific reasoning provided.
                </div>
            </div>
        </div>
    </div>

    <div id="stats-data" data-total="{{ total }}" data-closed="{{ closed_count }}" style="display:none;"></div>

    <div id="toast" class="glass"
        style="position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); padding: 12px 24px; border-radius: 12px; border: 1px solid var(--glass-border); background: rgba(16, 185, 129, 0.2); color: #10b981; backdrop-filter: blur(12px); z-index: 1000; transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); display: flex; align-items: center; gap: 10px;">
        <span>‚úÖ</span> <span id="toast-msg">Action Successful</span>
    </div>

    <script>
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            msgEl.textContent = msg;
            toast.style.background = isError ? 'rgba(239, 68, 68, 0.2)' : 'rgba(16, 185, 129, 0.2)';
            toast.style.color = isError ? '#ef4444' : '#10b981';
            toast.style.transform = 'translateX(-50%) translateY(0)';
            setTimeout(() => {
                toast.style.transform = 'translateX(-50%) translateY(100px)';
            }, 3000);
        }

        // ‚îÄ‚îÄ Modal Logic ‚îÄ‚îÄ
        function viewIssueDetails(data) {
            document.getElementById('modal-overlay').classList.add('active');

            // Populate basic info
            document.getElementById('modal-id').textContent = '#' + data.id;
            document.getElementById('modal-type').textContent = data.type;
            document.getElementById('modal-ward').textContent = 'Ward ' + data.ward;
            document.getElementById('modal-priority').textContent = data.priority;

            // Populate images
            document.getElementById('modal-before-img').src = '/static/uploads/' + data.before;

            const afterBox = document.getElementById('after-box');
            if (data.after && data.after !== 'None' && data.after !== '') {
                document.getElementById('modal-after-img').src = '/static/uploads/' + data.after;
                afterBox.style.display = 'block';
            } else {
                afterBox.style.display = 'none';
            }

            // Status Badge
            const statusBadge = document.getElementById('modal-status');
            statusBadge.textContent = data.status;
            statusBadge.className = 'badge ' + (data.status === 'OPEN' ? 'badge-open' : (data.status === 'CLOSED' ? 'badge-closed' : 'badge-progress'));

            // AI Insight
            document.getElementById('modal-confidence').textContent = (data.confidence || '0') + '% Confident';
            document.getElementById('modal-reasoning').textContent = data.reasoning || "No detailed reasoning available.";
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        // ‚îÄ‚îÄ Animated Counters ‚îÄ‚îÄ
        function animateCounters() {
            var elements = document.querySelectorAll('[data-count]');
            for (var i = 0; i < elements.length; i++) {
                (function (el) {
                    var target = parseInt(el.getAttribute('data-count'));
                    var duration = 1200;
                    var startTime = performance.now();
                    function tick(now) {
                        var elapsed = now - startTime;
                        var progress = Math.min(elapsed / duration, 1);
                        var ease = 1 - Math.pow(1 - progress, 3);
                        el.textContent = Math.floor(target * ease);
                        if (progress < 1) requestAnimationFrame(tick);
                        else el.textContent = target;
                    }
                    requestAnimationFrame(tick);
                })(elements[i]);
            }
        }

        // ‚îÄ‚îÄ Progress Bar Animation ‚îÄ‚îÄ
        function animateProgress() {
            var data = document.getElementById('stats-data');
            var total = parseInt(data.getAttribute('data-total'));
            var closed = parseInt(data.getAttribute('data-closed'));
            if (total > 0) {
                var pct = Math.round((closed / total) * 100);
                setTimeout(function () {
                    var fill = document.getElementById('progress-fill');
                    var label = document.getElementById('rate-pct');
                    if (fill) fill.style.width = pct + '%';
                    if (label) label.textContent = pct + '%';
                }, 600);
            }
        }

        // ‚îÄ‚îÄ Admin Deletion ‚îÄ‚îÄ
        async function confirmDelete(issueId) {
            if (confirm("Are you sure you want to delete this issue #" + issueId + "? This action cannot be undone.")) {
                try {
                    const response = await fetch(`/delete_issue/${issueId}`, {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        const row = document.getElementById(`issue-${issueId}`);
                        if (row) {
                            row.style.opacity = '0';
                            row.style.transform = 'translateX(20px)';
                            setTimeout(() => row.remove(), 400);
                        }
                        showToast(result.message || "Issue deleted successfully");
                    } else {
                        showToast(result.error || "Failed to delete issue", true);
                    }
                } catch (error) {
                    console.error("Error deleting issue:", error);
                    showToast("A network error occurred", true);
                }
            }
        }

        // Run after page loads
        setTimeout(animateCounters, 300);
        setTimeout(animateProgress, 500);

        // ‚îÄ‚îÄ Particles ‚îÄ‚îÄ
        var canvas = document.getElementById('particles-canvas');
        var ctx = canvas.getContext('2d');
        var particles = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        function Particle() { this.reset(); }
        Particle.prototype.reset = function () {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.size = Math.random() * 1.5 + 0.3;
            this.speedX = (Math.random() - 0.5) * 0.3;
            this.speedY = (Math.random() - 0.5) * 0.3;
            this.opacity = Math.random() * 0.25 + 0.05;
            this.hue = [239, 186, 155][Math.floor(Math.random() * 3)];
        };
        Particle.prototype.update = function () {
            this.x += this.speedX; this.y += this.speedY;
            if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) this.reset();
        };
        Particle.prototype.draw = function () {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fillStyle = 'hsla(' + this.hue + ', 70%, 60%, ' + this.opacity + ')';
            ctx.fill();
        };
        for (var i = 0; i < 35; i++) particles.push(new Particle());
        function animateP() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (var j = 0; j < particles.length; j++) { particles[j].update(); particles[j].draw(); }
            requestAnimationFrame(animateP);
        }
        animateP();
    </script>

</body>

</html>
<footer class="footer">
    <div class="footer-content">
        <div class="footer-brand">
            <span class="logo">üèõÔ∏è Civic Monitor</span>
            <p>The official civic observation and issue tracking system. Empowering citizens and responders to build a
                better city through AI and real-time data.</p>
            <div class="official-badge" style="margin-top: 15px;">
                üõ°Ô∏è Urban Tech Platform
            </div>
        </div>
        <div class="footer-links">
            <div class="footer-col">
                <h4>Operations</h4>
                <ul>
                    <li><a href="/">Login</a></li>
                    <li><a href="/register">Registration</a></li>
                    <li><a href="/dashboard">Dashboard</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Support</h4>
                <ul>
                    <li><a href="#">Help Center</a></li>
                    <li><a href="#">Contact Support</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <span>&copy; 2026 Civic Monitor System. All rights reserved.</span>
        <div style="display: flex; gap: 20px;">
            <span>v1.2.0-Alpha</span>
            <span>System Status: <span style="color: var(--green);">‚óè Online</span></span>
        </div>
    </div>
</footer>
</body>

</html>